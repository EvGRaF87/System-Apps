<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-t" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Удаление приложений</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary: #FF4500;
            --danger: #00c853;
            --danger1: #ff4242;
            --warning: #ff9100;
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e4e4e4;
            --text-secondary: #a0a0a0;
            --border: #424242;
            --transition: all 0.3s ease;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--dark-bg); color: var(--text-primary); font-family: 'Roboto', sans-serif; min-height: 100vh; display: flex; flex-direction: column; line-height: 1.6; }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; flex: 1; }
        header { background: #000000; padding: 15px 20px; border-bottom: 2px solid var(--danger); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo { width: 50px; height: 50px; border-radius: 50%; position: relative; overflow: hidden; box-shadow: 0 0 15px rgba(255, 69, 0); transition: var(--transition); border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; background: #000; }
        .logo img { width: 100%; height: 100%; object-fit: cover; display:block; }
        .logo.fallback { background: linear-gradient(135deg,#0f1113,#1a1a1a); display:flex; align-items:center; justify-content:center; }
        .logo-text { font-weight: 420; font-size: 1.5rem; color: white; letter-spacing: 0.5px; }
        .status-container { display:flex; align-items:center; gap:10px; background: rgba(0,200,83,0.06); padding:5px 15px; border-radius:15px; border:1px solid var(--danger); transition:var(--transition); }
        .status-indicator { width:15px; height:15px; background:var(--danger); border-radius:50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(0,200,83,0.7);} 70% { box-shadow:0 0 0 10px rgba(0,200,83,0);} 100% { box-shadow:0 0 0 0 rgba(0,200,83,0);} }
        .main-content { margin-top: 30px; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        .card { background: var(--card-bg); border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,.3); overflow:hidden; margin-bottom:25px; border:1px solid var(--border); transition:var(--transition); }
        .card-header { padding:15px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:center; background: rgba(0, 0, 0); }
        .card-title { font-size:1.2rem; display:flex; align-items:center; gap:10px; }
        .card-body { padding:25px; }
        .file-info { display:flex; justify-content:space-between; margin-bottom:20px; color:var(--text-secondary); align-items:center; }
        .editor-container { margin-bottom:20px; border-radius:8px; overflow:hidden; transition:var(--transition); }
        .editor-header { background:#000000; padding:10px 15px; border:1px solid var(--border); border-bottom:none; display:flex; justify-content:space-between; align-items:center; }
        textarea { width:100%; min-height:240px; background:#1a1a1a; color:var(--text-primary); border:1px solid var(--border); border-top:none; padding:15px; font-family:'Roboto Mono',monospace; resize:vertical; border-radius:0 0 5px 5px; transition:var(--transition); line-height:1.5; }
        textarea:focus { outline:none; border-color:var(--primary); box-shadow: inset 0 0 5px rgba(0,200,83,0.2); }
        .editor-hint { background:rgba(0, 0, 0); padding:2px 4px; border-radius:3px; margin-top:10px; color:var(--text-secondary); border-left:3px solid var(--warning); transition:var(--transition); }
        .button-group { display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; }
        .btn { padding:8px 15px; border-radius:5px; font-weight:500; cursor:pointer; border:none; display:flex; align-items:center; gap:8px; transition:var(--transition); font-size:0.90rem; }
        .btn-primary0 { background:var(--danger1); color:white; }
        .btn-primary { background:var(--danger); color:white; }
        .btn-secondary { background:#424242; color:var(--text-primary); }
        .system-info { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-top:30px; }
        .info-card { background:var(--card-bg); border-radius:8px; padding:15px; border:1px solid var(--border); transition:var(--transition); animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from{opacity:0;transform:translateX(-20px);} to{opacity:1;transform:translateX(0);} }
        .info-card h3 { font-size:1rem; margin-bottom:10px; display:flex; align-items:center; gap:8px; color:var(--text-secondary); }
        .info-card p { font-size:1.4rem; font-weight:410; color:var(--danger); }
        .toast-container { display:none; }
        
        .ad-container { 
            margin: 30px 0; 
            animation: fadeIn 0.5s ease-out;
        }
        .ad-card {
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }
        .ad-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border-color: var(--primary);
        }
        .ad-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(42,42,42,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .ad-body {
            padding: 20px;
        }
        .ad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .ad-item {
            background: rgba(42,42,42,0.3);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }
        .ad-item:hover {
            border-color: var(--primary);
            background: rgba(0,200,83,0.05);
        }
        .ad-item h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        .ad-item p {
            color: var(--text-secondary);
            flex-grow: 1;
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .ad-link {
            color: var(--danger);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }
        .ad-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width:768px) {
            header { flex-direction:column; gap:15px; text-align:center; }
            .file-info { flex-direction:column; gap:10px; align-items:flex-start; }
            .button-group { flex-direction:column; }
            .btn { width:100%; justify-content:center; }
            .ad-grid { grid-template-columns: 1fr; }
        }
        /* Компактный вариант кнопки */
.btn-compact {
    padding: 4px 10px;            /* было 12px 20px */
    font-size: 0.8rem;           /* было 0.95rem */
    border-radius: 4px;           /* было 5px */
    gap: 6px;                     /* было 8px */
    line-height: 1.2;
    min-height: 34px;             /* держим тап-зону разумной */
}

/* Уменьшаем иконки внутри компактных кнопок */
.btn-compact .material-icons {
    font-size: 18px;              /* по умолчанию крупнее */
}

/* Чуть плотнее кнопочная группа, если нужно */
.button-group.compact {
    gap: 8px;                     /* было 12px */
}
        
@media (max-width: 768px) {
    .btn-compact {
        padding: 8px 14px;
        font-size: 0.9rem;
        min-height: 38px;
    }
}

    .inline-actions {
    display: flex;
    flex-wrap: nowrap;      /* не даём кнопкам переноситься */
    gap: 8px;                /* расстояние между кнопками */
}

.inline-actions .btn {
    flex: 0 0 auto;          /* кнопки тянутся равномерно, если надо */
}
     /* --- Анимации --- */
@keyframes neonBorder {
    0%   { background-position: 0% 50%, 0 0; }
    50%  { background-position: 100% 50%, 0 0; }
    100% { background-position: 0% 50%, 0 0; }
}

@keyframes neonPulse {
    0%, 100% {
        box-shadow: 0 0 5px currentColor,
                    0 0 15px currentColor,
                    0 0 25px currentColor,
                    inset 0 0 8px currentColor;
    }
    50% {
        box-shadow: 0 0 10px currentColor,
                    0 0 25px currentColor,
                    0 0 45px currentColor,
                    inset 0 0 18px currentColor;
    }
}

/* --- Базовая неон‑обвязка --- */
.neon-container {
    border: 3px solid transparent;
    border-radius: 8px;
    background-origin: border-box;
    background-clip: padding-box, border-box;
    animation: neonBorder 6s linear infinite, neonPulse 0s ease-in-out infinite;
    transition: box-shadow 0.3s ease, transform 0.06s ease;
}
.neon-container:hover {
    transform: scale(1.01);
}

/* --- Цветовые схемы + смещения по времени --- */

/* Info-card — голубой→сиреневый→розовый */
.info-card.neon-container {
    color: #0ff;
    background-image: linear-gradient(#000, #000),
        linear-gradient(120deg, #00ffff, #8a2be2, #ff00ff, #00ffff);
    animation-delay: 0s, 0s;
}

/* Панель кнопок — зелёный→жёлтый→оранжевый */
.button-group.neon-container {
    color: #39ff14;
    background-image: linear-gradient(#000, #000),
        linear-gradient(120deg, #39ff14, #ffea00, #ff8c00, #39ff14);
    animation-delay: 2s, 0s;
}

/* Верхняя панель / редактор — розовый→голубой→фиолетовый */
.editor-actions.neon-container {
    color: #ff00ff;
    background-image: linear-gradient(#000, #000),
        linear-gradient(120deg, #ff00ff, #00ffff, #8a2be2, #ff00ff);
    animation-delay: 4s, 1s;
}

/* Общие контейнеры — радуга */
.container.neon-container, 
.panel.neon-container {
    color: #ff00ff;
    background-image: linear-gradient(#000, #000),
        linear-gradient(120deg, red, orange, yellow, green, cyan, blue, violet, red);
    animation-delay: 1s, 0s;
}

/* --- Неон для кнопок --- */
.btn-neon {
    position: relative;
    z-index: 1;
    border: 2px solid transparent;
    border-radius: 6px;
    background-origin: border-box;
    background-clip: padding-box, border-box;
    background-image: linear-gradient(#111, #111),
        linear-gradient(120deg, #0ff, #f0f, #0ff);
    animation: neonBorder 3s linear infinite, neonPulse 0s ease-in-out infinite;
    transition: transform 0.15s ease;
}
.btn-neon:hover {
    transform: scale(1.05);
}

/* Неон для скроллбара */
::-webkit-scrollbar {
    width: 10px;
}
::-webkit-scrollbar-track {
    background: #111;
}
::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #0ff, #f0f);
    border-radius: 5px;
    box-shadow: 0 0 10px #0ff, 0 0 20px #f0f;
}
::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #f0f, #0ff);
}
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <div class="logo" id="logoWrap">
                <img id="logoImg" alt="remosysapps Logo" />
            </div>
            <div class="logo-text">App RemoveR by SeRViP</div>
        </div>
        <div class="status-container">
            <div class="status-indicator"></div>
            <span>Ready to Uninstall Apps</span>
        </div>
    </header>

    <div class="container">
        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="material-icons">delete_forever</i> Removing System Applications</h2>
                </div>

                <div class="card-body">
                    <div class="file-info">
                        <span>Size: <span id="fileSize">загрузка...</span></span>
                    <button id="btnRefreshInfo" class="btn btn-secondary btn-compact btn-neon">
    <i class="material-icons">refresh</i> Update Info
</button>
                    </div>

                    <div class="editor-container">
                        <div class="editor-header">
                            <div class="editor-title"> List Packages for Debloat</div>
                              <div class="editor-actions btn-neon">
                                <button id="btnValidate" class="btn btn-secondary" style="padding:8px 16px;">
                                    <i class="material-icons">check_circle</i> Check the List
                                </button>
                            </div>
                        </div>
                        <textarea id="packageContent" placeholder="Enter the package names to remove, each on a new line..." spellcheck="false"></textarea>
                    </div>

                    <div class="editor-hint">
                        <i class="material-icons">info</i>
                        Введите по одному имени пакета в каждой строке (например, com.android.contacts). Строки, начинающиеся с #, будут проигнорированы.
                    </div>

                    <div class="button-group">
                        <button id="btnDebloat" class="btn btn-primary0 btn-compact btn-neon"><i class="material-icons">delete</i> Delete Applications</button>
                        <button id="btnInstall" class="btn btn-primary btn-compact btn-neon"><i class="material-icons">install_mobile</i> Install Applications</button>
                        <button id="btnReload" class="btn btn-secondary btn-compact btn-neon"><i class="material-icons">refresh</i> Clear Packages List</button>
                    </div>
                </div>
            </div>
            
                   <div class="ad-container">
            </div>

            <div class="system-info">
                <div class="info-card">
                    <h3><i class="material-icons">description</i> File Size</h3>
                    <p id="fileSizeInfo">download...</p>
                </div>
                <div class="info-card">
                    <h3><i class="material-icons">list</i> Number of Packages</h3>
                    <p id="packageCount">download...</p>
                </div>
                <div class="info-card">
                    <h3><i class="material-icons">verified_user</i> Verification Status</h3>
                    <p id="verificationStatus">Not Verified</p>
                </div>
            </div>
        </main>
    </div>
                        <!-- Блок рекламы -->
            <div class="ad-container">
                <div class="ad-card" onclick="window.location.href='add.html'">
                    <div class="ad-header">
                        <i class="material-icons">apps</i>
                        <h2 class="card-title">Other developments SeRViP</h2>
                    </div>
                    <div class="ad-body">
                        <p>Other modules from the Developer "Remove System Apps" </p>
                        <div class="ad-grid">
                            <div class="ad-item btn-neon">
                                <h4><i class="material-icons">contacts</i> ColorOS-Dialer_Universal</h4>
                                <p>Module for OnePlus/Realme owners, for Color Dialer/Mms functionality after converting to Global ROMs Android 15.</p>
                                <a href="https://github.com/EvGRaF87/Oplus-Dialer" class="ad-link" onclick="event.stopPropagation()">
                                    <i class="material-icons">open_in_new</i> GitHub
                                </a>
                            </div>
                            <div class="ad-item btn-neon">
                                <h4><i class="material-icons">camera</i> OP13T-Drivers</h4>
                                <p>Module for OnePlus 13T owners, for fix camera functionality and correct battery capacity after updating or converting to OxygenOS 15.</p>
                                <a href="https://github.com/EvGRaF87/OP13T-Drivers" class="ad-link" onclick="event.stopPropagation()">
                                    <i class="material-icons">open_in_new</i> GitHub
                                </a>
                            </div>
                            <div class="ad-item btn-neon">
                                <h4><i class="material-icons">mms</i>Music_Live_Allert</h4>
                                <p>Module for adding music (and other) applications to the live notification panel.</p>
                                <a href="https://disk.yandex.ru/d/NMbge9V6koeukw" class="ad-link" onclick="event.stopPropagation()">
                                    <i class="material-icons">open_in_new</i> Yandex Disk
                                </a>
                    </div>
                <div class="ad-card" onclick="window.location.href='add.html'">
                    <div class="ad-header">
                        <i class="material-icons">apps</i>
                        <h2 class="card-title">Other projects Developer </h2>
                                </a>
                    </div>
                    <div class="ad-body">
                            <div class="ad-item btn-neon">
                                <h4><i class="material-icons">search</i> OTAFinder</h4>
                                <p>A repository of scripts for searching for update packages for BBK devices (OPPO, OnePlus, Realme). Installation and operation in the Termux terminal (Root is not required).</p>
                                <a href="https://github.com/EvGRaF87/OTAFinder" class="ad-link" onclick="event.stopPropagation()">
                                    <i class="material-icons">open_in_new</i> GitHub
                                </a>
                            </div>
                    <div class="ad-grid">
                            <div class="ad-item btn-neon">
                                <h4><i class="material-icons">download</i> OTA Downloader</h4>
                                <p>A repository of scripts for downloads OTA packages BBK devices (OPPO, OnePlus, Realme). Installation and operation in the Termux terminal (Root is not required).</p>
                                <a href="https://github.com/EvGRaF87/OTADownloadeR" class="ad-link" onclick="event.stopPropagation()">
                                    <i class="material-icons">open_in_new</i> GitHub
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
    import { exec as ksuExec, toast as ksuToast } from './kernelsu.js';

    const LOGO_PATH = '/data/adb/modules/remosysapps/logo.png';
    const PACKAGES_FILE = '/data/adb/modules/remosysapps/debloat_list.txt';

    const logoImg = document.getElementById('logoImg');
    const logoWrap = document.getElementById('logoWrap');

    const packageContent = document.getElementById('packageContent');
    const btnDebloat = document.getElementById('btnDebloat');
    const btnReload = document.getElementById('btnReload');
    const btnValidate = document.getElementById('btnValidate');
    const fileSizeInfo = document.getElementById('fileSizeInfo');
    const packageCount = document.getElementById('packageCount');
    const verificationStatus = document.getElementById('verificationStatus');
    const fileSizeLabel = document.getElementById('fileSize');

    let originalContent = '';

    function showToast(message, type = 'info') {
        try { ksuToast && ksuToast(message); } catch(e){ /*ignore*/ }
        console.log(`[toast:${type}] ${message}`);
    }

    function escapeForSingleQuotes(str) {
        return str.replace(/'/g, "'\"'\"'");
    }

    async function execCmd(cmd) {
        try {
            const res = await ksuExec(cmd);
            return res;
        } catch (err) {
            throw new Error('exec error: ' + (err && err.message ? err.message : err));
        }
    }
    
    async function loadLogoImage() {
        const escaped = escapeForSingleQuotes(LOGO_PATH);
        try {
            let cmd = `base64 -w 0 '${escaped}'`;
            let res = await execCmd(cmd);
            let b64 = '';
            if (res && res.stdout && String(res.stdout).trim()) {
                b64 = String(res.stdout).trim();
            } else {
                cmd = `base64 '${escaped}' | tr -d '\\n'`;
                res = await execCmd(cmd);
                if (res && res.stdout && String(res.stdout).trim()) {
                    b64 = String(res.stdout).trim();
                }
            }

            if (!b64) {
                try {
                    const pyCmd = `python3 -c "import base64,sys;print(base64.b64encode(open('${LOGO_PATH}','rb').read()).decode())"`;
                    const resPy = await execCmd(pyCmd);
                    if (resPy && resPy.stdout && String(resPy.stdout).trim()) {
                        b64 = String(resPy.stdout).trim();
                    }
                } catch (pyErr) {
                    console.warn('python3 fallback failed:', pyErr);
                }
            }

            if (b64) {
                if (b64.length < 20) throw new Error('base64 output слишком короткий — возможно не изображение');
                logoImg.src = 'data:image/png;base64,' + b64;
                logoWrap.classList.remove('fallback');
                showToast('Логотип загружен', 'info');
                return;
            } else {
                throw new Error('Не удалось получить base64 содержимое файла логотипа');
            }
        } catch (err) {
            console.warn('loadLogoImage error:', err);
            logoWrap.classList.add('fallback');
            logoImg.remove(); 
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', '48');
            svg.setAttribute('height', '48');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.innerHTML = `
                <circle cx="12" cy="12" r="11" fill="#0f1720"/>
                <path d="M12 2 L15 8 L22 9 L17 14 L18 21 L12 18 L6 21 L7 14 L2 9 L9 8 Z" fill="#00c853" opacity="0.95"/>
            `;
            logoWrap.innerHTML = '';
            logoWrap.appendChild(svg);
            showToast('Не удалось загрузить логотип', 'info');
        }
    }

    function validateContent(content) {
        const lines = content.split(/\r?\n/);
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line !== '' && !line.startsWith('#') && !/^[a-zA-Z0-9_.-]+$/.test(line)) {
                return { valid: false, message: `Ошибка в строке ${i+1}: недопустимый формат имени пакета.` };
            }
        }
        return { valid: true, message: 'Формат списка корректен.' };
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / 1048576).toFixed(2) + ' MB';
    }

    async function readFileContentAbsolute(absPath) {
        const escaped = escapeForSingleQuotes(absPath);
        const cmd = `cat '${escaped}'`;
        const res = await execCmd(cmd);
        if (res && (res.errno === 0 || (res.stderr === '' && res.stdout !== undefined))) {
            return res.stdout !== undefined ? res.stdout : '';
        } else {
            const errMsg = res && (res.stderr || res.stdout) ? (res.stderr || res.stdout) : 'Не удалось прочитать файл (errno=' + (res && res.errno) + ')';
            throw new Error(errMsg);
        }
    }

    async function loadFileContent() {
        try {
            showToast('Загрузка списка приложений...', 'info');
            const content = await readFileContentAbsolute(PACKAGES_FILE);
            originalContent = content;
            packageContent.value = originalContent;
            const size = new Blob([content]).size;
            fileSizeInfo.textContent = formatFileSize(size);
            fileSizeLabel.textContent = formatFileSize(size);
            const lines = content.split(/\r?\n/).filter(l => { const t = l.trim(); return t !== '' && !t.startsWith('#'); });
            packageCount.textContent = `${lines.length} Packages`;
            verificationStatus.textContent = 'Not Verified';
            verificationStatus.style.color = 'var(--danger1)';
            showToast('Список успешно загружен', 'info');
        } catch (err) {
            console.error('Ошибка загрузки файла:', err);
            showToast('Ошибка при загрузке списка: ' + (err && err.message ? err.message : err), 'error');
            packageContent.value = "# Ошибка загрузки файла\n# Проверьте путь и права доступа";
            fileSizeInfo.textContent = '—';
            packageCount.textContent = '—';
            verificationStatus.textContent = 'Ошибка загрузки';
            verificationStatus.style.color = 'var(--danger1)';
        }
    }
    
    const btnRefreshInfo = document.getElementById('btnRefreshInfo');

btnRefreshInfo.addEventListener('click', async () => {
    try {
        showToast('Обновление данных info-card...', 'info');
        const content = packageContent.value;
        const size = new Blob([content]).size;
        fileSizeInfo.textContent = formatFileSize(size);
        fileSizeLabel.textContent = formatFileSize(size);

        const lines = content.split(/\r?\n/)
            .filter(l => {
                const t = l.trim();
                return t !== '' && !t.startsWith('#');
            });
        packageCount.textContent = `${lines.length} Packages`;

        const validation = validateContent(content);
        if (validation.valid) {
            verificationStatus.textContent = 'Verified';
            verificationStatus.style.color = 'var(--danger)';
        } else {
            verificationStatus.textContent = 'Validation error';
            verificationStatus.style.color = 'var(--danger1)';
        }

        showToast('Данные info-card обновлены', 'info');
    } catch (err) {
        showToast('Ошибка при обновлении info-card: ' + err.message, 'error');
    }
});

    async function executeDebloat() {
        const content = packageContent.value;
        const validation = validateContent(content);
        if (!validation.valid) {
            showToast(validation.message, 'error');
            verificationStatus.textContent = 'Validation error';
            verificationStatus.style.color = 'var(--danger1)';
            return;
        }

        const packagesToRemove = content.split(/\r?\n/).filter(line => {
            const trimmed = line.trim();
            return trimmed !== '' && !trimmed.startsWith('#');
        });

        if (packagesToRemove.length === 0) {
            showToast('Список для удаления пуст.', 'warning');
            return;
        }

        showToast(`Начинаю удаление ${packagesToRemove.length} приложений...`, 'info');

        for (const pkg of packagesToRemove) {
            const cmd = `pm uninstall --user 0 ${escapeForSingleQuotes(pkg.trim())}`;
            try {
                const res = await execCmd(cmd);
                if (res && res.stdout && res.stdout.toLowerCase().includes('success')) {
                    showToast(`Приложение ${pkg} удалено.`, 'info');
                } else {
                    showToast(`Ошибка удаления ${pkg}: ${res.stderr || 'Неизвестная ошибка'}`, 'error');
                }
            } catch (err) {
                showToast(`Критическая ошибка при удалении ${pkg}: ${err.message}`, 'error');
            }
        }
        showToast('Процесс удаления завершен.', 'info');
    }
    
    async function executeInstall() {
        const content = packageContent.value;
        const validation = validateContent(content);
        if (!validation.valid) {
            showToast(validation.message, 'error');
            verificationStatus.textContent = 'Validation error';
            verificationStatus.style.color = 'var(--danger1)';
            return;
        }

        const packagesToInstall = content.split(/\r?\n/).filter(line => {
            const trimmed = line.trim();
            return trimmed !== '' && !trimmed.startsWith('#');
        });

        if (packagesToInstall.length === 0) {
            showToast('Список для установки пуст.','warning');
            return;
        }

        showToast(`Начинаю установку ${packagesToInstall.length} приложений...`, 'info');

        for (const pkg of packagesToInstall) {
            const cmd = `pm install-existing --user 0 ${escapeForSingleQuotes(pkg.trim())}`;
            try {
                const res = await execCmd(cmd);
                if (res && res.stdout && res.stdout.toLowerCase().includes('installed')) {
                    showToast(`Приложение ${pkg} установлено.`, 'info');
            } else {
                showToast(`Ошибка установки ${pkg}: ${res.stderr || 'Неизвестная ошибка'}`, 'error');
                }
            } catch (err) {
                showToast(`Критическая ошибка при установке ${pkg}: ${err.message}`, 'error');
            }
        }
        showToast('Процесс установки завершён.', 'info');
    }

    btnDebloat.addEventListener('click', executeDebloat);
    btnInstall.addEventListener('click', executeInstall);
    btnReload.addEventListener('click', () => {
        packageContent.value = ' ' ;
        showToast('Список пакетов очищен.', 'info');
    });
    btnValidate.addEventListener('click', () => {
        const validation = validateContent(packageContent.value);
        if (validation.valid) {
            showToast(validation.message, 'info');
            verificationStatus.textContent = 'Verified';
            verificationStatus.style.color = 'var(--danger)';
        } else {
            showToast(validation.message, 'error');
            verificationStatus.textContent = 'Validation error';
            verificationStatus.style.color = 'var(--danger1)';
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        await loadLogoImage();
        await loadFileContent();
    });
    </script>
</body>
</html>
